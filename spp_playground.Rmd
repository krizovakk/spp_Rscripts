---
title: "SPP Playground"
author: "Katerina Krizova"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: false
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in
---

# VR RIZENI ODCHYLKY

VR na dodavatele rizeni odchylky EE
ted PowereX
v soutezi 
  PowereX (chceme i dal)
  energas
  Energodata

task:
  overit, zda nejsou data z energas a Energodat tototzna
  Market se tak jevi
  chce overit

task 2:
  podezreni na to, ze energodata komunikuji s energasem ve dnech, kdy energas jeste nemel data o spotrebe od nas
  diky tomu energas upravuje predikce blize spotrebe
  
  denni predicke za cca 2 mesice
  dat do grafu oba dodavatele a porovnat krivky
  
brainstorm:
  dodavatel posila predikce v den D na D+1
  
ENERGAS:
  75 csv souboru * 96 radku pro 24*4 (denni pocet 15-minutovek)
  == 7200 hodnot
  
ENERGODATA:
  77 csv souboru * 96 radku pro 24*4 (denni pocet 15-minutovek)
  == 7392 hodnot

## read and process, join

```{r}
require(tidyverse)
require(openxlsx)

path_in <- "X:/Nakup _ NEW/Elektřina/VR_rizeni_odchylky_EE/"
path_out <- "C:/Users/krizova/Documents/R/playground/"

# ERERGAS ======================================================================
raw_egas <- data.frame()
Legas <- list.files(paste0(path_in, "energas/predikce_energas/"), full.names = T)

for(i in Legas){
  a <- read.csv(i, header = TRUE, sep = ";")
  # a <- read.delim(i, col.names = TRUE)
  raw_egas <- rbind(raw_egas, a)
  print(i)
}

egas <- raw_egas %>% 
  mutate(datum = case_when(
    grepl("^\\d{4}-\\d{2}-\\d{2}$", Date) ~ as.Date(Date, format = "%Y-%m-%d"),
    grepl("^\\d{2}\\.\\d{2}\\.\\d{4}", Date) ~ as.Date(Date, format = "%d.%m.%Y %H:%M"),
    TRUE ~ as.Date(NA))) %>% 
  arrange(datum, Period) %>%
  mutate(id = seq_along(Prediction))

# ERERGODATA ===================================================================
raw_edat <- data.frame()
Ledat <- list.files(paste0(path_in, "Energodata/Predikce_energodata/"), full.names = T)

for(i in Ledat){
  a <- read.xlsx(i)
  raw_edat <- rbind(raw_edat, a)
  print(i)
}

edat <- raw_edat %>% 
  mutate(datum = as.Date(Timestamp, format = "%Y-%m-%d %H:%M:%S"),
         tmstmp = as.Date(Timestamp)) %>% 
  arrange(tmstmp) %>% 
  mutate(id = seq_along(Predikcia),
         pred_round2 = round(Predikcia, 2)) %>% 
  group_by(datum) %>% 
  mutate(Period = seq_along(Predikcia)) %>% 
  ungroup()

# POWEREX + SPP SPOTREBA =======================================================
raw_spp <- read.xlsx(paste0(path_in, "predikce_powerex_spotreba.xlsx"))
spp <- raw_spp %>% 
  mutate(datum = as.Date(Den, origin = "1899-12-30"),
         Period = `čtvrthodina._`)

# JOIN =========================================================================

join <- inner_join(egas %>% select(datum, Period, Prediction), edat %>% select(datum, Period, Predikcia, pred_round2), by = c("datum" = "datum", "Period" = "Period"), keep = T) %>% 
  mutate(id = seq_along(Predikcia),
         diff = abs(Prediction-Predikcia),
         weekday = weekdays(datum.x),
         dayIndex = as.numeric(factor(datum.x)))

join2 <- inner_join(join, spp %>% select(datum, Period, "hodina" = Hod, "powerex" = Pozice.MWh, "spot" = Spotřeba.MWh), 
                    by = c("datum.x" = "datum", "Period.x" = "Period"), keep = T) %>% 
  mutate(bigID = seq_along(datum.x))

# join$label_colored <- ifelse(
#   join$weekday %in% c("Saturday", "Sunday"),
#   paste0("<span style='color:red;'>", format(join$Date, "%d.%m"), "</span>"),
#   paste0("<span style='color:black;'>", format(join$Date, "%d.%m"), "</span>")
# )

```

## plot general results

```{r}
# PLOTS ========================================================================

require(ggplot2)

# predikce vse a jen vybrane (uncomment)

gvse <- ggplot(join2)+
  geom_line(aes(x = bigID, y = spot, color = "SPP spotreba"))+
  geom_line(aes(x = bigID, y = Predikcia, color = "Energodata"), , linewidth = 1.1)+
  geom_line(aes(x = bigID, y = Prediction, color = "energas"))+
  geom_line(aes(x = bigID, y = powerex, colour = "PowereX"))+
  scale_color_manual(values = c(
      "SPP spotreba" = "grey40",
      "Energodata" = "dodgerblue3",
      "energas" = "orange",
      "PowereX" = "darkgreen"))+
  labs(x = "", y = "MWh", title = "Predikce spotreby EE", color = "")+
  scale_x_continuous(breaks = join2$bigID[seq(1, nrow(join2), by = 96)], labels = join2$datum.x[seq(1, nrow(join2), by = 96)])+
  theme_linedraw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "top")
gvse
ggsave(paste0(path_out, "VRodchylkaEE_energas_Energodata_spotreba_do20250623.jpg"), device = "jpg", width = 45, height = 9, dpi = 300)

require(plotly)
library(htmlwidgets)

a <- ggplotly(gvse)
saveWidget(a, file=paste0(path_out, "VRodchylkaEE_interaktivni_vse_do20250623.html"))


# rozdil energas Energodata

g3 <- ggplot(join2, aes(x = bigID, y = diff))+
  geom_line(colour = "red")+ #
  # scale_x_continuous(breaks = join$id, labels = join$datum.x)+
  scale_x_continuous(
    breaks = join2$id[seq(1, nrow(join2), by = 96)],
    labels = join2$datum.x[seq(1, nrow(join2), by = 96)]
  ) +
  labs(x = "", y = "rozdil v MWh", title = "Rozdil odchylek predikovanych spolecnostmi energas a Energodata")+
  theme_linedraw()+
  # theme(axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.5, hjust = 1))
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
g3
ggsave(paste0(path_out, "VRodchylkaEE_energas_Energodata_absROZDIL_do20250625.jpg"), device = "jpg", width = 45, height = 9, dpi = 300)

# // // // vikendy cervene

label_positions <- join2 %>%
  group_by(datum.x) %>%
  summarise(
    x_pos = min(bigID),  # or whatever your continuous x-axis variable is
    is_weekend = weekdays(datum.x[1]) %in% c("Saturday", "Sunday")
  ) %>%
  mutate(
    label_colored = ifelse(
      is_weekend,
      paste0("<span style='color:red;'>", format(datum.x, "%d.%m"), "</span>"),
      paste0("<span style='color:black;'>", format(datum.x, "%d.%m"), "</span>")
    )
  )

g5 <- ggplot(join2, aes(x = bigID, y = diff)) +
  geom_line(colour = "red") +
  scale_x_continuous(
    breaks = label_positions$x_pos,
    labels = label_positions$label_colored) +
  labs(x = "", y = "rozdil v MWh", title = "Rozdil odchylek predikovanych spolecnostmi energas a Energodata")+
  theme_linedraw() +
  theme(axis.text.x = element_markdown(angle = 90, vjust = 0.5, hjust = 1)) 
g5
ggsave(paste0(path_out, "VRodchylkaEE_energas_Energodata_absROZDIL_vikendCervene_do20250625.jpg"), device = "jpg", width = 45, height = 9, dpi = 300)

```

24.04.2025
26.04.2025
28.04.2025
01.05.2025
02.05.2025
03.05.2025
04.05.2025
05.05.2025
06.05.2025
13.05.2025
19.05.2025
21.05.2025
23.05.2025
24.05.2025
25.05.2025
01.06.2025
07.06.2025
08.06.2025
10.06.2025

## plot selected days

```{r}

sel_date <- "2025-04-24"

sel <- join2 %>% filter(datum == sel_date)

gsel <- ggplot(sel)+
  geom_line(aes(x = id, y = spot), colour = "grey40")+
  geom_line(aes(x = bigID, y = Predikcia), colour = "dodgerblue3", linewidth = 1.1)+
  geom_line(aes(x = bigID, y = Prediction), colour = "orange")+
  labs(x = "date", y = "MW")+
  theme_minimal()+
  # scale_x_continuous(
  #   breaks = sel$bigID[seq(1, nrow(sel), by = 96)],
  #   labels = sel$datum.x[seq(1, nrow(sel), by = 96)]
  # ) +
  labs(x = paste0(sel_date), y = "difference in MWh")+
  theme_linedraw()+
  # theme(axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.5, hjust = 1))
  theme(axis.text.x = element_blank())
gsel
ggsave(paste0(path_out, "graf_energas_energodata_predikce_pro", sel_date), device = "jpg", width = 45, height = 9, dpi = 300)

```

jen pro ucely doplneni do Rhacks

```{r}
df <- join2 %>% select("id" = bigID, "datum" = datum.x, "predikce1" = Prediction, "predikce2" = Predikcia)
```

```{r}
require(plotly)
library(htmlwidgets) # save the widget

a <- ggplotly(gvse)

saveWidget(a, file=paste0(path_out, "plotly-line-chart.html"))
```

# PRESUN 2024 REPORTU DO SLOZKY

kod funkcni
na nektere soubory jsem nemela prava - hodilo warning, ale proces pokracoval, tzn. preneslo se, co slo, zbytek zustal v puvodni slozce

```{r}
# 
# L2024 <- list.files("X:/ICIS_Heren/", pattern = paste0("2024.pdf"), full.names = T) 
# 
# for (i in L2024) {
#     file.copy(from = i,
#           to = "X:/ICIS_Heren/backup")
# } 
# 
# source_dir <- "X:/ICIS_Heren/"
# dest_dir <- "X:/ICIS_Heren/ICIS_2024"
# files <- list.files(source_dir, pattern = paste0("2024.pdf"), full.names = TRUE)
# dest_files <- file.path(dest_dir, basename(files))
# file.rename(files, dest_files)
# 
# for (i in L2024) {
#   dest_dir <- "X:/ICIS_Heren/ICIS_2024"
#     file.copy(from = i,
#           to = "X:/ICIS_Heren/backup")
# } 
```

# ZPRACOVANI PDF

```{r}

library(pdftools)

text <- pdf_text("X:/ICIS_Heren/20250703_ICIS Markets - Gas Europe - Netherlands.pdf")
str1 <- text[1]
high <- str_extract(text, regex("Highlights.*?\n{5,}", dotall = TRUE))
lines <- str_split(high, "\n")[[1]]
clearLines <- str_trim(str_remove(lines, "\""))
clearLines <- clearLines[clearLines != ""] 
clearLines <- clearLines[-1]

         

```

# KYC Torreol

bylo treba nacist zaheslovany excel, ale heslo prislo driv, nez jsem nasla cestu pres R :-)
```{r}
library(readxl)
df <- read_excel("X:/Nakup _ NEW/04_EFET-FA/Torreol/KYC/250731_KYC questionnaire.xlsx")

```

# DT 60' to 15'

```{r}

require(tidyverse)
require(xlsx)
# install.packages("writexl")
library(writexl)

tab <- read.delim("clipboard")

df <- rbind(tab, tab[rep(1:nrow(tab), 3), ]) %>% 
  arrange(den, hodina) %>% 
  group_by(den, hodina) %>% 
  mutate(ctvrt = seq_along(hodina),
         ctvrt = case_when(ctvrt == 1 ~ 00,
                           ctvrt == 2 ~ 15,
                           ctvrt == 3 ~ 30,
                           ctvrt == 4 ~ 45),
         # hodina = str_extract(hodina, "^..")
         ) %>% 
  ungroup() %>% 
  select(den, hodina, ctvrt, cena)

write.table(df, "clipboard", sep = "\t", row.names = FALSE)
write_xlsx(x = df,                       
           path = "C:/Users/krizova/Documents/playground/temp.xlsx")

```

# AGC Kryry - predikce

AGC Kryry posilaji predikce ve wide formatu na cely mesic
Je treba si to rozlozit do long formatu
TO DO: v excelu si zkopiruj hodnoty do List 1
        vysledek kodu bude v clipboardu

```{r}
library(tidyverse)
library(readxl)
df <- read_excel("C:/Users/krizova/Documents/playground/AGC_Kryry/nominace_CAL25.xlsx", sheet = "List1")

agc <- df %>% 
  pivot_longer(
    cols = -datum, 
    names_to = "hour",
    values_to = "value"
  ) %>% 
  mutate(hodina = readr::parse_number(hour),
         MW = value/1000) %>% select(datum, hodina, MW)

write.table(agc, "clipboard", sep = "\t", dec = ",",row.names = FALSE)

```

# FOSFA - predikce

```{r}
library(tidyverse)
library(readxl)
df <- read_excel("C:/Users/krizova/Documents/playground/Fosfa/Fosfa_nominace_zari2025.xlsx", sheet = "Red", col_names = F)
df <- df[1:30, 2:97]


# library(dplyr)
# library(tidyr)

fosf <- df %>% 
  mutate(date_col = as.Date("01.09.2025", format = "%d.%m.%Y") + row_number() - 1) %>% 
  pivot_longer(
    cols = -date_col,        # all columns except the date column
    names_to = "variable",   # optional: keep track of which column the value came from
    values_to = "value"
  ) %>%
  select(date_col, value) %>% 
  mutate(hod = rep(0:23, each = 4, length.out = n()),
         ctvrt = rep(1:4, length.out = n()),
         MW = value/1000)
  
  
  pivot_longer(
    cols = -datum, 
    names_to = "hour",
    values_to = "value"
  ) %>% 
  mutate(hodina = readr::parse_number(hour),
         MW = value/1000) %>% select(datum, hodina, MW)

write.table(agc, "clipboard", sep = "\t", dec = ",", row.names = FALSE)

```
# PRESVATKOVANI

https://chatgpt.com/c/68d112b2-d0a8-832d-ba95-3c1865d7a1f1

tipy:

 from = as.POSIXct("2025-01-01 00:00:00", tz = "UTC"), # timezone UTC (jak to dela PwX)


DONE: 

```{r}

library(tidyverse)
library(lubridate)
library(readxl)
library(tsibble)

# 2024 *** OK ***

y24 <- read_excel("C:/Users/krizova/Documents/R/cenove_kalkukacky/Bohemia Sekt_profil 2024_EE - kopie.xlsx", 
                 col_names = T) %>% 
  mutate(weekday = wday(date, week_start = 1),
         month = lubridate::month(timestamp),
         day = lubridate::day(timestamp),
         md = paste0(month, "-", day),
         id = seq_along(date)) %>% 
  group_by(date) %>% mutate(hour = seq_along(date)) %>% 
  ungroup() %>% 
  select(id, md, timestamp, date, weekday, hour, mwh)

# 2025,6,7 *** OK ***

timestamps <- seq(
  from = as.POSIXct("2025-01-01 00:00:00"),
  to   = as.POSIXct("2027-12-31 23:59:00"),
  by   = "hour"
)

yx <- data.frame(timestamp = timestamps) %>% 
  mutate(
    date = lubridate::date(timestamp),
    weekday = wday(date, week_start = 1),
    year = lubridate::year(timestamp),
    month = lubridate::month(timestamp),
    day = lubridate::day(timestamp),
    md = paste0(month, "-", day)
   ) %>% 
  group_by(date) %>% mutate(hour = seq_along(date)) %>% 
  ungroup() %>% 
  mutate(
         hol = case_when(md %in% c("1-1", 
                                   "5-1", "5-8", "7-5", "7-6", 
                                   "9-8", "10-28", "11-17",
                                   "12-24", "12-25", "12-26") ~ "ph", # public holiday
                        date %in% c("2025-04-18", "2026-04-03", "2027-03-26") ~ "easter_friday",
                        date %in% c("2025-04-19", "2026-04-04", "2027-03-27") ~ "easter_saturday",
                        date %in% c("2025-04-20", "2026-04-05", "2027-03-28") ~ "easter_sunday",
                        date %in% c("2025-04-21", "2026-04-06", "2027-03-29") ~ "easter_monday",
                        TRUE ~ "reg"), # regular
         id = seq_along(date)) %>% 
  select(id, md, timestamp, date, weekday, hol)
 
check <- yx %>% filter(str_detect(timestamp, "12:00:00$"))

# filter year

y25 <- yx %>% 
  # filter(year == 2025)
  filter(str_detect(timestamp, "^2025"))

y26 <- yx %>% 
  filter(str_detect(timestamp, "^2026"))

y27 <- yx %>% 
  filter(str_detect(timestamp, "^2027"))

```

WIP: 

```{r}

library(tidyverse)
library(lubridate)
library(readxl)
library(tsibble)

# 2024 

diagram <- read_excel("C:/Users/krizova/Documents/R/cenove_kalkukacky/Bohemia Sekt_profil 2024_EE - kopie.xlsx", 
                 col_names = T) %>% 
  mutate(weekday = wday(date, week_start = 1),
         year = lubridate::year(date),
         month = lubridate::month(date),
         week = lubridate::week(date),
         day = lubridate::day(date),
         md = paste0(month, "-", day),
         hol = case_when(md %in% c("1-1", 
                                   "5-1", "5-8", "7-5", "7-6", 
                                   "9-8", "10-28", "11-17",
                                   "12-24", "12-25", "12-26") ~ "ph", # public holiday
                        date == "2024-03-29" ~ "easter_friday",
                        date == "2024-03-30" ~ "easter_saturday",
                        date == "2024-03-31" ~ "easter_sunday",
                        date == "2024-04-01" ~ "easter_monday",
                        TRUE ~ "reg")) %>% 
  group_by(date) %>% mutate(hour = seq_along(date)) %>% 
  ungroup() %>% 
  select(year, month, week, weekday, day, hour, hol, date, mwh) %>% 
  filter(hour == 12) # jen operativne pro prehled - pak smazat

val_y1 <- unique(max(diagram$year))+1 # v pripade, ze nebude diagram za jeden kalendarni rok, ale treba prelom (proto max)
val_y2 <- unique(max(diagram$year))+2
val_y3 <- unique(max(diagram$year))+3

# 2025

future <- tibble(
  timestamp = seq(
    from = as.POSIXct(paste0(y1, "-01-01 00:00:00"), tz = "Europe/Prague"),
    to   = as.POSIXct(paste0(y1, "-12-31 23:00:00"), tz = "Europe/Prague"),
    by   = "hour")) %>% 
  mutate(
    date = as_date(timestamp),
    weekday = wday(timestamp, week_start = 1),  # Monday = 1
    year = lubridate::year(timestamp),
    month = lubridate::month(timestamp),
    week = lubridate::week(timestamp),
    day = lubridate::day(timestamp),
    md = paste0(month, "-", day),
    hol = case_when(md %in% c("1-1", 
                                   "5-1", "5-8", "7-5", "7-6", 
                                   "9-8", "10-28", "11-17",
                                   "12-24", "12-25", "12-26") ~ "ph", # public holiday
                        date %in% c("2025-04-18", "2026-04-03", "2027-03-26") ~ "easter_friday",
                        date %in% c("2025-04-19", "2026-04-04", "2027-03-27") ~ "easter_saturday",
                        date %in% c("2025-04-20", "2026-04-05", "2027-03-28") ~ "easter_sunday",
                        date %in% c("2025-04-21", "2026-04-06", "2027-03-29") ~ "easter_monday",
                        TRUE ~ "reg")) %>% 
  group_by(date) %>% mutate(hour = seq_along(date)) %>% 
  ungroup() %>% 
  select(year, month, week, weekday, hour, hol, date) %>% 
  filter(hour == 12) # jen operativne pro prehled - pak smazat
  
tr <- y25 %>% left_join(y24 %>% select(week, weekday, day, hour, mwh), by = c("week", "weekday", "hour")) %>% 
  rename("mwh_wday" = mwh) %>% 
  left_join(y24 %>% select(month, day, hour, hol, mwh), by = c("month", "day", "hour", "hol")) 
  mutate(mwh_hol = ifelse(hol == "ph", mwh, NA))
  







# day_counts <- y25 %>% count(date) # check no of days

first_wd_25 <- wday(min(y25$date), week_start = 1)  # 1 = Monday

easter <- y24 %>% 
  filter(grepl("^easter.*", y24$hol))

y24_shifted <- y24 %>%
  mutate(wd = wday(date, week_start = 1)) %>%
  filter(row_number() >= min(which(wd == first_wd_25))) %>%
  select(-wd) %>%
  left_join(y24 %>% filter()) %>% 
  mutate(id = seq_along(date))

y25_ <- y25 %>%
  left_join(y24_shifted %>% select(id, mwh), by = "id") %>% #dle weekday
  # mutate(mwh_na = ifelse(is.na(mwh), ))
  rename("mwh_wd" = mwh) %>% 
  left_join(y24 %>% select(id, mwh), by = "id") %>% 
  rename("mwh_date" = mwh) %>% 
  left_join(y24 %>% select(hol, mwh) %>% filter(str_detect(hol, "^easter")), by = "hol") %>% 
  rename("mwh_easter" = mwh) 
  mutate(mwh_final = ifelse(hol == "reg", mwh_wd, mwh_date))


```

experiment KK - wip

```{r}

y24 <- read_excel("C:/Users/krizova/Documents/R/cenove_kalkukacky/Bohemia Sekt_profil 2024_EE - kopie.xlsx", 
                 col_names = T) %>% 
  mutate(weekday24 = wday(date, week_start = 1),
         month = lubridate::month(date),
         day = lubridate::day(date),
         md = paste0(month, "-", day),
         id = seq_along(date),
         hol = case_when(md %in% c("1-1", 
                                   "5-1", "5-8", "7-5", "7-6", 
                                   "9-8", "10-28", "11-17",
                                   "12-24", "12-25", "12-26") ~ "ph", # public holiday
                        date == "2024-03-29" ~ "easter_friday",
                        date == "2024-03-30" ~ "easter_saturday",
                        date == "2024-03-31" ~ "easter_sunday",
                        date == "2024-04-01" ~ "easter_monday",
                        TRUE ~ "reg")) %>% 
  group_by(date) %>% mutate(hour = seq_along(date)) %>% 
  ungroup() %>% 
  select(id, md, hol, mwh, "date24" = date, weekday24, hour)

# y24 <- tibble(
#   timestamp = seq(
#     from = as.POSIXct("2024-01-01 00:00:00", tz = "Europe/Prague"),
#     to   = as.POSIXct("2024-12-31 23:00:00", tz = "Europe/Prague"),
#     by   = "day")) %>%
#   mutate(
#     date24 = as_date(timestamp),
#     weekday24 = wday(timestamp, week_start = 1),
#     id = seq_along(date24)) 

y25 <- tibble(
  timestamp = seq(
    from = as.POSIXct("2025-01-01 00:00:00", tz = "Europe/Prague"),
    to   = as.POSIXct("2025-12-31 23:00:00", tz = "Europe/Prague"),
    by   = "hour")) %>%
  mutate(
    date25 = as_date(timestamp),
    weekday25 = wday(timestamp, week_start = 1),
    month = lubridate::month(timestamp),
    day = lubridate::day(timestamp),
    md = paste0(month, "-", day),
    hol25 = case_when(md %in% c("1-1", 
                                   "5-1", "5-8", "7-5", "7-6", 
                                   "9-8", "10-28", "11-17",
                                   "12-24", "12-25", "12-26") ~ "ph", # public holiday
                        date25 %in% c("2025-04-18", "2026-04-03", "2027-03-26") ~ "easter_friday",
                        date25 %in% c("2025-04-19", "2026-04-04", "2027-03-27") ~ "easter_saturday",
                        date25 %in% c("2025-04-20", "2026-04-05", "2027-03-28") ~ "easter_sunday",
                        date25 %in% c("2025-04-21", "2026-04-06", "2027-03-29") ~ "easter_monday",
                        TRUE ~ "reg"),
    id = seq_along(date25)+48) 

y26 <- tibble(
  timestamp = seq(
    from = as.POSIXct("2026-01-01 00:00:00", tz = "Europe/Prague"),
    to   = as.POSIXct("2026-12-31 23:00:00", tz = "Europe/Prague"),
    by   = "hour")) %>%
  mutate(
    date26 = as_date(timestamp),
    weekday26 = wday(timestamp, week_start = 1),
    id = seq_along(date26)+72) 

mat <- full_join(y24 %>% select(id, mwh, hol, date24, weekday24), 
                 y25 %>% select(id, hol25, date25, weekday25), by = "id") %>% 
  full_join(y26 %>% select(id, date26, weekday26), by = "id")

view(mat)

# apply

res25 <- mat %>% 
  select(mwh, date24, hol25, date25, weekday25) %>%
  mutate(mwh_temp = case_when(hol25 == "ph" ~ mwh[date24==date25],
                              TRUE ~ mwh))

```

```{r}

# Data 2024: denní
dny2024 <- seq(as.Date("2024-01-01"), as.Date("2024-12-31"), by = "day")
set.seed(123)
hodnoty2024 <- rnorm(length(dny2024), 10, 2)

# Data 2025: denní
dny2025 <- seq(as.Date("2025-01-01"), as.Date("2025-12-31"), by = "day")

# Den v týdnu (1 = pondělí, ..., 7 = neděle)
wday2024 <- as.integer(format(dny2024, "%u"))
wday2025 <- as.integer(format(dny2025, "%u"))

# Mapování: pro každý den v 2025 najdeme nejbližší datum v 2024 se stejným wday
prirazeni <- sapply(seq_along(dny2025), function(i) {
  idx <- which(wday2024 == wday2025[i])
  # vezmeme datum, které je v roce 2024 "nejblíže"
  idx[which.min(abs(as.numeric(dny2024[idx]) - as.numeric(dny2025[i])))]
})

# Hodnoty z 2024 přeneseme na rok 2025
hodnoty2025 <- hodnoty2024[prirazeni]

# Výsledek
head(data.frame(dny2025, hodnoty2025), 10)
a <- data.frame(dny2025, hodnoty2025, wday2025)


y24 <- data.frame(dny2024, hodnoty2024, wday2024)

```

# lubridate cheatsheet

```{r}

library(tidyverse)
library(lubridate)

dt <- as_datetime(1511870400)

ymd_hms(dt)
ymd_hm(dt) # nefu
ymd_h(dt) # nefu

dmy_hms(dt) # nefu

now(tzone = "Europe/Prague")
now(tzone = "UTC")

parse_date_time(dt) # nefu

dst(dt)
dst(now(tzone = "Europe/Prague"))
leap_year(dt)

ceiling_date(dt, unit = "week")

i <- interval(ymd("2017-01-01"), 10)
j <- 4 %--% ymd("2017-12-10") 


int_shift(i, days(-2))

```


