---
title: "EEX indices - web scraping"
author: "Katerina Krizova"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: false
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in
---

!!! semi-automatic !!!

need to find proper chunk of a source code and copy it to clipboard
set the delivery date
after that it is all automatic

# SET DELIVERY DATE

```{r}
# !! set delivery date !!

date <- as.Date(Sys.Date(), format = "%d.%m.%Y")
class(date)

date <- as.Date("23.6.2025", format = "%d.%m.%Y") # set if you need to process any other day than today

# !! set delivery date !!
```

# EGSI

segment <tbody>
specifikace: text-align: left

```{r}
require(tidyverse)
require(stringr)

# read from clipboard
text <- readClipboard()
print(text)

# match indices and prices
matches <- str_match_all(
  text,
  '<td style="text-align: left;">(.*?)</td><td style="text-align: left;">(\\d{1,3}(?:,\\d{3})*)</td>'
)[[1]]

# create table
df <- data.frame(
  index = matches[, 2],
  value = matches[, 3],
  stringsAsFactors = FALSE
) %>% 
  mutate(value = round(as.numeric(str_replace(value, ",", ".")), 3))

egsi <- df %>% 
  filter(index %in% c("CZ VTP", "THE", "TTF")) %>% 
  mutate('Delivery date' = date,
         Index = "EEX Spot EGSI") %>% 
  pivot_wider(names_from = index, values_from = value) %>% 
  relocate(Index, .before = 'Delivery date')
```

# EOD

segment <tbody>
specifikace: text-align: righ

```{r}
require(tidyverse)
require(stringr)

# read from clipboard
text <- paste(readClipboard(), collapse = "\n")
print(text)

# match indices and prices

pattern <- '<tr class="mv-quote-row".*?><td style="text-align: left;">(.*?)</td><td style="text-align: right;">(.*?)</td><td style="text-align: right;">(.*?)</td><td style="text-align: right;">(.*?)</td>'

matches <- str_match_all(text, pattern)[[1]]

# Create data frame with raw string values preserved
df <- data.frame(
  index = matches[, 2],
  lastPrice = str_trim(matches[, 3]),
  lastVolume = str_trim(matches[, 4]),
  EOD = str_trim(matches[, 5]),
  stringsAsFactors = FALSE
) %>% 
  mutate(lastPrice = str_remove(lastPrice, "-"), 
         lastVolume = str_remove(lastVolume, "&nbsp;"),
         EOD = as.numeric(str_replace(EOD, ",", "\\."))) %>% 
  select(index, EOD)

eod <- df %>% # tbd
  filter(index %in% c("CZ VTP Day Ahead", "THE Day Ahead", "TTF Day Ahead")) %>% 
  mutate('Delivery date' = date,
         Index = "EEX Spot EOD") %>% 
  pivot_wider(names_from = index, values_from = EOD) %>% 
  relocate(Index, .before = 'Delivery date')
```
# FUTURES

```{r}

df <- data.frame(
  date = character(),
  value1 = numeric(),
  value2 = numeric(),
  value3 = numeric(),
  value4 = numeric(),
  value5 = numeric(),
  value6 = numeric(),
  value7 = numeric(),
  value8 = numeric(),
  value9 = numeric(),
  stringsAsFactors = FALSE
)

new_row <- data.frame(
  # date = as.Date(date, format = "%d.%m.%Y"),
  date = format(date, "%d.%m.%Y"),
  value1 = 36.211, # VTP Cal+1
  value2 = 36.595, # VTP Q+1
  value3 = 36.327, # VTP M+1
  value4 = 36.327, # THE Cal+1
  value5 = 36.327, # THE Q+1
  value6 = 36.327, # THE M+1
  value7 = 36.327, # TTF Cal+1
  value8 = 36.327, # TTF Q+1
  value9 = 36.327  # TTF M+1
)

df <- rbind(df, new_row)
names(new_row) <- c("Delivery date", "VTP Cal+1", "VTP Q+1", "VTP M+1",
                    "THE Cal+1", "THE Q+1", "THE M+1",
                    "TTF Cal+1", "TTF Q+1", "TTF M+1")


```
